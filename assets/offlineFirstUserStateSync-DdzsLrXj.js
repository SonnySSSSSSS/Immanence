const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/progressStore-Bvvoe9Qv.js","assets/index-NOppfZ3u.js","assets/index-D8RXJINZ.css","assets/settingsStore-8ZsGBHpS.js","assets/navigationStore-BgVzVa0e.js","assets/pathStore-B4T55qPM.js","assets/curriculumStore-B2DA8_aQ.js","assets/userModeStore-BUZIY82Y.js","assets/mandalaStore-DNoGG3m5.js"])))=>i.map(i=>d[i]);
import{q as e}from"./index-NOppfZ3u.js";import{n as t}from"./offlineFirstUserStateKeys-CS2DAPl9.js";function n(e){if(typeof e!=`string`)return{parsed:null,parseOk:!1};try{return{parsed:JSON.parse(e),parseOk:!0}}catch{return{parsed:null,parseOk:!1}}}function r(e){let r=Array.isArray(e)?e:[],i=new Date().toISOString(),a={};if(typeof window>`u`||!window?.localStorage)return{schema:`progress_bundle_v1`,capturedAt:i,keys:a};for(let e of r){if(!t.has(e))continue;let r=null;try{r=window.localStorage.getItem(e)}catch{r=null}let{parsed:i,parseOk:o}=n(r);a[e]={raw:r,parsed:o?i:null,parseOk:o}}return{schema:`progress_bundle_v1`,capturedAt:i,keys:a}}function i(e,n){let r=Array.isArray(n)?n:[],i=new Set(r.filter(e=>t.has(e)));if(typeof window>`u`||!window?.localStorage||!e||typeof e!=`object`||e.schema!==`progress_bundle_v1`)return;let a=e.keys&&typeof e.keys==`object`?e.keys:{};for(let[e,t]of Object.entries(a))if(i.has(e)&&!(!t||typeof t!=`object`))try{typeof t.raw==`string`?window.localStorage.setItem(e,t.raw):t.parseOk&&window.localStorage.setItem(e,JSON.stringify(t.parsed??null))}catch{}}var a=`immanence-device-id`,o=`immanence-sync-outbox-v1`,s=`immanence-sync-last-enqueued-hash-v1`,c=`immanence-sync-last-pushed-hash-v1`,l=`immanence-sync-last-applied-remote-at-v1`;function u(){return typeof window<`u`&&!!window?.localStorage}function d(){return new Date().toISOString()}function f(){if(!u())return`unknown-device`;try{let e=window.localStorage.getItem(a);if(e)return e}catch{}let e=(globalThis.crypto?.randomUUID?.()??null)||`${Date.now()}-${Math.random().toString(16).slice(2)}`;try{window.localStorage.setItem(a,e)}catch{}return e}function p(e,t){if(!u())return t;try{let n=window.localStorage.getItem(e);return n?JSON.parse(n):t}catch{return t}}function m(e,t){if(u())try{window.localStorage.setItem(e,JSON.stringify(t))}catch{}}function h(e){if(!u())return null;try{return window.localStorage.getItem(e)}catch{return null}}function g(e,t){if(u())try{typeof t==`string`&&window.localStorage.setItem(e,t)}catch{}}function _(e){let t=new WeakSet,n=e=>{if(e===null)return`null`;let r=typeof e;return r===`string`?JSON.stringify(e):r===`number`?Number.isFinite(e)?String(e):JSON.stringify(null):r===`boolean`?e?`true`:`false`:r===`undefined`?`null`:r===`bigint`?JSON.stringify(String(e)):r===`function`||r===`symbol`?`null`:Array.isArray(e)?`[${e.map(n).join(`,`)}]`:r===`object`?t.has(e)?JSON.stringify(`[Circular]`):(t.add(e),`{${Object.keys(e).sort().map(t=>`${JSON.stringify(t)}:${n(e[t])}`).join(`,`)}}`):JSON.stringify(null)};return n(e)}function v(e){let t=5381;for(let n=0;n<e.length;n+=1)t=(t<<5)+t^e.charCodeAt(n);return(t>>>0).toString(16)}function y(e,t){let n=Array.isArray(t)?t:[],r=[];for(let t of n){let n=e?.keys?.[t],i=n&&typeof n==`object`?n.raw:null,a=typeof i==`string`?i:n?.parseOk?_(n?.parsed??null):null;r.push([t,a])}return v(_({schema:e?.schema??null,keys:r}))}function b(){return p(o,[])}function x(e){m(o,Array.isArray(e)?e:[])}function S(e){let t=b();t.push(e),x(t)}async function C(){let t=await Promise.allSettled([e(()=>import(`./progressStore-Bvvoe9Qv.js`),__vite__mapDeps([0,1,2])),e(()=>import(`./settingsStore-8ZsGBHpS.js`),__vite__mapDeps([3,1,2])),e(()=>import(`./navigationStore-BgVzVa0e.js`),__vite__mapDeps([4,1,2])),e(()=>import(`./pathStore-B4T55qPM.js`),__vite__mapDeps([5,1,2])),e(()=>import(`./curriculumStore-B2DA8_aQ.js`),__vite__mapDeps([6,1,2])),e(()=>import(`./userModeStore-BUZIY82Y.js`),__vite__mapDeps([7,1,2]))]);for(let e of t){if(e.status!==`fulfilled`)continue;let t=e.value;for(let e of Object.values(t)){let t=e?.persist?.rehydrate;if(typeof t==`function`)try{await t()}catch{}}}try{let t=await e(()=>import(`./mandalaStore-DNoGG3m5.js`),__vite__mapDeps([8,1,2]));typeof t?.syncFromProgressStore==`function`&&t.syncFromProgressStore()}catch{}}function w(e){if(!e||typeof e!=`string`)return null;let t=Date.parse(e);return Number.isFinite(t)?t:null}function T(){return typeof document>`u`?!0:!document.hidden}function E(){return typeof navigator>`u`?!0:navigator.onLine!==!1}function D({supabase:e,keys:t,debug:n=!1}){if(!e||typeof window>`u`)return()=>{};let a=f(),o=new Set,u=(...e)=>{n&&console.log(`[userStateSync]`,...e)},p=(e,...t)=>{n&&(o.has(e)||(o.add(e),u(...t)))},m=!1,_=null,v=!1,D=()=>{let e=y(r(t),t);h(c)||g(c,e),h(s)||g(s,e)},O=()=>{let e=r(t),n=y(e,t),i=h(s),o=h(c);return n===i||n===o?{bundle:e,currentHash:n,enqueued:!1}:(S({id:`${Date.now()}-${Math.random().toString(16).slice(2)}`,type:`UPSERT_DOC`,doc_key:`progress_bundle_v1`,bundle:e,capturedAt:e.capturedAt,device_id:a}),g(s,n),u(`enqueued`,{hash:n,outboxSize:b().length}),{bundle:e,currentHash:n,enqueued:!0})},k=async n=>{if(!E())return;let r=b();if(!Array.isArray(r)||r.length===0)return;let i=0;for(;!m&&i<r.length;){let a=r[i];if(!a||a.type!==`UPSERT_DOC`){i+=1;continue}let o={user_id:n,doc_key:a.doc_key,doc:a.bundle,updated_at:d(),updated_by_device:a.device_id},l;try{l=await e.from(`user_documents`).upsert(o,{onConflict:`user_id,doc_key`})}catch(e){l={error:e}}if(l?.error){p(`supabase_push_error`,`push failed (local-only mode continues)`,l.error);return}let f=y(a.bundle,t);g(c,f),g(s,f),r.splice(i,1),x(r),u(`pushed`,{hash:f,remaining:r.length})}},A=async n=>{if(!E())return;let a=e.from(`user_documents`).select(`doc`).eq(`doc_key`,`progress_bundle_v1`),o;try{o=await(typeof a.maybeSingle==`function`?a.maybeSingle():a.single())}catch(e){o={error:e}}if(o?.error){let e=o.error?.code||o.error?.details||``;if(String(e).includes(`PGRST116`))return;p(`supabase_pull_error`,`pull failed (local-only mode continues)`,o.error);return}let d=o?.data?.doc??null;if(!d||d.schema!==`progress_bundle_v1`)return;let f=w(d.capturedAt);if(!f||f<=(w(h(l))??0))return;let m=y(r(t),t),_=h(c);if(!_||m!==_){u(`skip apply (local diverged)`,{localHash:m,lastPushedHash:_});return}i(d,t),await C();let v=y(d,t);g(l,d.capturedAt),g(c,v),g(s,v),u(`applied remote`,{capturedAt:d.capturedAt,hash:v,userId:n})},j=async()=>{if(!m&&T()&&!v){v=!0;try{let{data:t,error:n}=await e.auth.getSession();if(n)return;let r=(t?.session??null)?.user?.id??null;if(!r)return;O(),await k(r),await A(r)}finally{v=!1}}};D(),j(),_=window.setInterval(j,3e3);let M=()=>j(),N=()=>{T()&&j()};try{window.addEventListener(`online`,M),document.addEventListener(`visibilitychange`,N)}catch{}return u(`started`,{deviceId:a,userIdKey:`auth.uid()`,keysCount:Array.isArray(t)?t.length:0}),()=>{m=!0;try{_&&window.clearInterval(_)}catch{}try{window.removeEventListener(`online`,M),document.removeEventListener(`visibilitychange`,N)}catch{}u(`stopped`)}}export{D as initOfflineFirstUserStateSync};