# TASK-2026-01-05-C: Add Thought Detachment Ritual Program Card

**Created:** 2026-01-05
**Recommended Executor:** Antigravity
**Scope:** Add new program card with dedicated onboarding flow
**Goal:** Introduce "Thought Detachment Ritual" as a selectable program alongside existing curriculum

---

## Program Name

**Final Choice:** Thought Detachment Ritual

This name clearly indicates:
- The practice method (thought observation/detachment)
- The structured format (ritual)
- Distinction from existing "Explore Non-Duality" program

---

## Behavior Requirements (Locked)

### Programs Grid Display
- New card appears in the Programs screen (Navigation Section)
- Grid shows existing programs + new "Thought Detachment Ritual" card
- Card positioned after current programs
- Visual consistency with existing program cards

### Card Selection
- Clicking card immediately launches program-specific onboarding
- No intermediate screens or confirmations
- Direct entry to onboarding flow

### Onboarding Flow
- Multi-step modal-based flow (similar to existing `CurriculumOnboarding.jsx`)
- Cancel button available on every step
- Cancel â†’ return to Programs grid with NO state changes
- Completion â†’ generate payload and pass to curriculum handler

### Post-Onboarding
- On completion: normal program interaction proceeds
- Onboarding never repeats unless explicitly re-entered
- User can access program practices/tracking

---

## Where the New Card Is Added

**File:** `src/components/Cycle/ConsistencyFoundation.jsx`

**Location:** Programs grid section (around line 45-70 in the "No cycle active" conditional)

**Current Structure:**
```jsx
if (!currentCycle) {
    return (
        <>
            <div className="p-6 rounded-3xl...">
                // Existing "BEGIN FOUNDATION CYCLE" button
            </div>

            <CycleChoiceModal ... />
        </>
    );
}
```

**New Structure:**
```jsx
if (!currentCycle) {
    return (
        <>
            {/* Programs Grid */}
            <div className="grid grid-cols-2 gap-4 mb-6">
                {/* Existing Program Card */}
                <ProgramCard
                    title="Foundation Cycle"
                    description="14-day structured practice"
                    icon="ðŸŒ±"
                    onClick={() => setShowCycleChoice(true)}
                />

                {/* NEW: Thought Detachment Ritual Card */}
                <ProgramCard
                    title="Thought Detachment Ritual"
                    description="5-8 recurring thoughts observation"
                    icon="ðŸŒŠ"  // or alternative: ðŸ’­, ðŸ§˜, ðŸª·
                    onClick={() => setShowThoughtDetachmentOnboarding(true)}
                />
            </div>

            <CycleChoiceModal ... />
            <ThoughtDetachmentOnboarding
                isOpen={showThoughtDetachmentOnboarding}
                onClose={() => setShowThoughtDetachmentOnboarding(false)}
            />
        </>
    );
}
```

**Alternative:** If a new `ProgramCard` component doesn't exist, replicate the existing button pattern:
```jsx
<button
    onClick={() => setShowThoughtDetachmentOnboarding(true)}
    className="p-4 rounded-xl..."
>
    <div className="text-2xl mb-2">ðŸŒŠ</div>
    <h4>Thought Detachment Ritual</h4>
    <p>5-8 recurring thoughts observation</p>
</button>
```

---

## Onboarding Entry and Exit Wiring

### Entry Point

**Component:** `ThoughtDetachmentOnboarding.jsx` (new file)

**Props:**
```jsx
{
    isOpen: boolean,
    onClose: () => void  // Cancel handler
}
```

**Trigger:** User clicks "Thought Detachment Ritual" card in ConsistencyFoundation

**State:** Local modal state in `ConsistencyFoundation.jsx`:
```javascript
const [showThoughtDetachmentOnboarding, setShowThoughtDetachmentOnboarding] = useState(false);
```

### Exit Points

**1. Cancel (at any step):**
```javascript
const handleCancel = () => {
    onClose();  // Close modal, return to Programs grid
    // NO state changes to curriculumStore
    // NO curriculum activation
};
```

**2. Complete (final step):**
```javascript
const handleComplete = () => {
    const payload = {
        timeSlots: selectedTimeSlots,  // e.g., ['19:00', '21:00']
        thoughts: thoughtEntries        // Array of {text, weight}
    };

    // Use existing curriculum handler
    completeOnboarding(payload.timeSlots, payload.thoughts);

    onClose();  // Close onboarding modal
};
```

---

## Onboarding Flow Steps

### Step 1: Welcome
- **Content:**
  - Title: "Thought Detachment Ritual"
  - Description: "A 14-day practice observing recurring thoughts without engagement"
  - Philosophy: "Not about changing thoughts, but changing your relationship to them"
- **Actions:** Continue â†’ Step 2, Cancel â†’ exit

### Step 2: Thought Collection
- **Content:**
  - Prompt: "Enter 5-8 recurring thoughts that occupy your mind"
  - Input: Speech-to-text or manual entry (reuse `SpeechToTextInput.jsx`)
  - Examples: "I'm not good enough", "What if I fail?", "I need to fix this"
- **Validation:** Require 5-8 thoughts minimum
- **Actions:** Continue â†’ Step 3, Back â†’ Step 1, Cancel â†’ exit

### Step 3: Priority Marking
- **Content:**
  - List all entered thoughts
  - User marks 1-2 as "priority" (higher selection weight)
  - Explanation: "Priority thoughts appear more frequently in practice"
- **Actions:** Continue â†’ Step 4, Back â†’ Step 2, Cancel â†’ exit

### Step 4: Time Selection
- **Content:**
  - Select 2 practice times (same UI as existing CurriculumOnboarding)
  - One for evening ritual slot
  - One for optional morning review
- **Validation:** Require 2 time slots
- **Actions:** Start Program â†’ Complete, Back â†’ Step 3, Cancel â†’ exit

### Minimal UI Version (if needed)
For proof-of-concept, steps can be condensed to:
1. Welcome + Thought Entry (5-8 thoughts)
2. Time Selection
3. Confirmation

---

## Payload Shape

### Data Structure
```javascript
{
    timeSlots: string[],     // e.g., ['19:00', '21:00']
    thoughts: Array<{
        text: string,        // "I'm not good enough"
        weight: number       // 0 = normal, 1 = priority
    }>
}
```

### Example Payload
```javascript
{
    timeSlots: ['19:00', '21:00'],
    thoughts: [
        { text: "I'm not good enough", weight: 1 },
        { text: "What if I fail?", weight: 0 },
        { text: "I need to fix this", weight: 0 },
        { text: "They don't understand me", weight: 1 },
        { text: "I should be further along", weight: 0 }
    ]
}
```

---

## Exact Handoff Point

**Function:** `curriculumStore.completeOnboarding(timeSlots, thoughts)`

**Location:** `src/state/curriculumStore.js:70`

**Current Signature:**
```javascript
completeOnboarding: (timeSlots = [], thoughts = []) => {
    const now = new Date().toISOString();
    set({
        onboardingComplete: true,
        onboardingDismissed: false,
        practiceTimeSlots: timeSlots,
        thoughtCatalog: thoughts.map((t, idx) => ({
            id: `thought-${Date.now()}-${idx}`,
            text: t.text,
            weight: t.weight || 0,
            createdAt: now,
        })),
        curriculumStartDate: now,
    });
}
```

**Usage in ThoughtDetachmentOnboarding:**
```javascript
import { useCurriculumStore } from '../state/curriculumStore.js';

// Inside component
const { completeOnboarding } = useCurriculumStore();

const handleComplete = () => {
    completeOnboarding(selectedTimeSlots, thoughtEntries);
    onClose();
};
```

**Result:**
- `onboardingComplete` = true
- `practiceTimeSlots` = user's selected times
- `thoughtCatalog` = processed thought objects with IDs
- `curriculumStartDate` = current timestamp
- Curriculum becomes active, daily practice begins

---

## Cancel Behavior

**All Steps:**
```javascript
<button onClick={onClose}>
    Cancel
</button>
```

**Effect:**
- Modal closes immediately
- Returns to Programs grid (ConsistencyFoundation view)
- NO calls to `completeOnboarding()`
- NO writes to curriculumStore state
- User can re-enter onboarding later
- All local form state discarded

**Edge Case - Partial Progress:**
- If user enters 3 thoughts then cancels: data lost
- This is expected behavior (no draft saving)
- User must restart from Step 1 on re-entry

---

## ALLOWLIST (Files to Modify)

### New Files
- `src/components/ThoughtDetachmentOnboarding.jsx` - Main onboarding component

### Modified Files
- `src/components/Cycle/ConsistencyFoundation.jsx` - Add program card and modal trigger

### Optional (if needed)
- `src/components/ProgramCard.jsx` - Reusable program card component (if extracting pattern)
- `src/components/ui/PillButton.jsx` - Already exists, may reuse

---

## DENYLIST (Files NOT to Touch)

- `src/state/curriculumStore.js` - DO NOT modify, use existing API
- `src/state/cycleStore.js` - No changes needed
- `src/components/CurriculumOnboarding.jsx` - Do not refactor existing onboarding
- `src/components/CycleChoiceModal.jsx` - Leave untouched
- `src/data/ritualFoundation14.js` - No curriculum data changes
- `src/App.jsx` - No routing changes required
- ALL other navigation components (PathSelectionGrid, PathOverviewPanel, etc.)

---

## Implementation Constraints

### No Architectural Refactors
- Do not extract shared onboarding abstractions
- Do not create new state management patterns
- Do not modify existing curriculum flow

### Minimal UI Sufficient
- Plain modals acceptable for proof-of-concept
- Reuse existing button/input components
- Match existing visual style loosely (exact pixel-perfect not required)

### Reuse Existing Mechanisms
- Use `useCurriculumStore().completeOnboarding()` as-is
- Reuse `SpeechToTextInput.jsx` if available
- Reuse `PillButton.jsx` for actions
- Follow `CurriculumOnboarding.jsx` patterns for step navigation

### No Behavior Changes to Existing Programs
- "Foundation Cycle" card remains functional
- Existing onboarding flows untouched
- No impact on current curriculum users

---

## Visual Design Notes

### Program Card (in ConsistencyFoundation)

**Appearance:**
- Icon: ðŸŒŠ (or ðŸ’­, ðŸ§˜, ðŸª· - choose one)
- Title: "Thought Detachment Ritual"
- Subtitle: "5-8 recurring thoughts observation"
- Style: Match existing Foundation Cycle button aesthetic
- Hover: Subtle accent color glow
- Layout: 2-column grid (existing + new)

**Light Mode:**
- Background: `rgba(255,255,255,0.7)`
- Border: `rgba(180, 140, 90, 0.25)`
- Text: `rgba(60, 52, 37, 0.9)`

**Dark Mode:**
- Background: `linear-gradient(135deg, #161625 0%, #1a1a2e 100%)`
- Border: `rgba(255,255,255,0.1)`
- Text: `white`

### Onboarding Modal

**Structure:**
- Full-screen modal overlay (like `CurriculumOnboarding`)
- Centered content panel (max-width: 600px)
- Header: Step indicator (1/4, 2/4, etc.)
- Body: Step content
- Footer: Back, Cancel, Continue/Start buttons

**Styling:**
- Reuse existing modal backdrop: `rgba(0,0,0,0.8)`
- Content panel: Glass morphism effect
- Buttons: `PillButton` component
- Inputs: Match existing form styles

---

## Manual Test Steps

### Test 1: Card Appears
1. Navigate to Navigation section
2. Verify "Thought Detachment Ritual" card visible in Programs grid
3. Verify card positioned alongside "Foundation Cycle"
4. Verify icon, title, description render correctly

### Test 2: Onboarding Entry
1. Click "Thought Detachment Ritual" card
2. Verify onboarding modal opens immediately
3. Verify Step 1 (Welcome) content displays
4. Verify Cancel button present

### Test 3: Cancel Flow
1. Enter onboarding (Step 1)
2. Click Cancel
3. Verify modal closes
4. Verify returned to Programs grid
5. Verify no curriculum state changes (check curriculumStore.onboardingComplete = false)
6. Click card again - verify onboarding restarts from Step 1

### Test 4: Navigation Between Steps
1. Complete Step 1 â†’ Click Continue
2. Verify Step 2 displays
3. Click Back â†’ Verify Step 1 returns
4. Click Continue â†’ Step 2 again
5. Repeat for all steps

### Test 5: Thought Entry
1. Navigate to Step 2 (Thought Collection)
2. Enter 3 thoughts manually
3. Verify validation prevents continuing (need 5 minimum)
4. Enter 2 more thoughts (total 5)
5. Verify Continue button enabled
6. Enter 3 more thoughts (total 8)
7. Verify all 8 thoughts listed

### Test 6: Priority Marking
1. Navigate to Step 3 (Priority Marking)
2. Verify all entered thoughts listed
3. Mark 2 thoughts as priority
4. Verify visual indication (checkbox, highlight, etc.)
5. Continue to Step 4

### Test 7: Time Selection
1. Navigate to Step 4 (Time Selection)
2. Select first time slot (e.g., 19:00)
3. Verify validation prevents continuing (need 2 slots)
4. Select second time slot (e.g., 21:00)
5. Verify Continue/Start button enabled

### Test 8: Complete Onboarding
1. Complete all steps with valid data
2. Click "Start Program"
3. Verify modal closes
4. Check curriculumStore state:
   - `onboardingComplete` = true
   - `practiceTimeSlots` = ['19:00', '21:00']
   - `thoughtCatalog` = array of 5-8 thoughts with IDs
   - `curriculumStartDate` = valid timestamp
5. Verify curriculum practices become accessible

### Test 9: Onboarding Does Not Repeat
1. Complete onboarding once (Test 8)
2. Navigate away from Navigation section
3. Return to Navigation section
4. Verify onboarding does NOT auto-launch
5. Verify program is active/accessible

### Test 10: Existing Programs Unaffected
1. Verify "Foundation Cycle" card still present
2. Click "Foundation Cycle"
3. Verify existing CycleChoiceModal opens
4. Verify existing onboarding flow works
5. Cancel and verify return to grid

### Test 11: Light/Dark Mode
1. Switch to light mode
2. Verify program card renders correctly
3. Open onboarding modal
4. Verify all steps render correctly in light mode
5. Switch to dark mode
6. Verify visual consistency

### Test 12: Responsive Behavior
1. Test in Sanctuary mode (1366px viewport)
2. Verify card grid layout adapts
3. Verify modal remains centered
4. Test in Hearth mode (1080px viewport)
5. Verify no overflow or clipping

---

## Success Criteria

### Definition of DONE
- [ ] New "Thought Detachment Ritual" card visible in Programs grid
- [ ] Card click launches ThoughtDetachmentOnboarding modal
- [ ] Cancel button on all steps returns to grid without state changes
- [ ] Complete flow generates payload: `{timeSlots: [...], thoughts: [...]}`
- [ ] Payload passed to `curriculumStore.completeOnboarding()`
- [ ] Onboarding does not repeat after completion
- [ ] Existing "Foundation Cycle" functionality unchanged
- [ ] All 12 manual tests pass
- [ ] Dev server runs without errors
- [ ] No console errors or warnings
- [ ] `docs/WORKLOG.md` updated in same commit with:
  - TASK ID: TASK-2026-01-05-C
  - Files modified
  - Commit hash
  - Status: COMPLETED

### Not Required for DONE
- Pixel-perfect design (functional UI sufficient)
- Animations/transitions (static modals acceptable)
- Error handling beyond basic validation
- Accessibility enhancements (ARIA, keyboard nav)
- Mobile optimization
- Unit tests

---

## Recommended Implementation Order

1. **Create ProgramCard component** (if extracting pattern)
   - Extract from existing Foundation Cycle button
   - Make reusable with props: title, description, icon, onClick

2. **Modify ConsistencyFoundation.jsx**
   - Replace single button with 2-column grid
   - Add state: `showThoughtDetachmentOnboarding`
   - Add new card with click handler

3. **Create ThoughtDetachmentOnboarding.jsx**
   - Start with Step 1 (Welcome) only
   - Test modal open/close
   - Test Cancel behavior

4. **Add Step 2: Thought Collection**
   - Reuse SpeechToTextInput if available, else plain textarea
   - Add validation (5-8 thoughts)
   - Test Back/Continue navigation

5. **Add Step 3: Priority Marking**
   - List all thoughts with checkboxes
   - Allow 1-2 priority selections
   - Update thought objects with weight

6. **Add Step 4: Time Selection**
   - Reuse time picker from CurriculumOnboarding
   - Require 2 selections
   - Add "Start Program" button

7. **Wire Complete handler**
   - Build payload from collected data
   - Call `completeOnboarding(timeSlots, thoughts)`
   - Close modal

8. **Test full flow**
   - Run all 12 manual tests
   - Fix bugs
   - Verify no regressions

9. **Update WORKLOG.md**
   - Add entry with TASK ID
   - Include commit hash
   - Mark COMPLETED

10. **Commit**
    - Single atomic commit with code + worklog
    - Follow commit message template below

---

## Commit Message Template

```
feat: add Thought Detachment Ritual program card - TASK-2026-01-05-C

New program in NavigationSection with dedicated onboarding flow.

Changes:
- Added ThoughtDetachmentOnboarding.jsx (4-step modal flow)
- Modified ConsistencyFoundation.jsx (added program card grid)
- [Optional] Extracted ProgramCard.jsx component

Features:
- Welcome + philosophy introduction
- 5-8 thought collection with speech-to-text
- Priority marking (1-2 thoughts weighted 3x)
- Time slot selection (2 slots required)
- Cancel on any step (no state changes)
- Complete â†’ curriculumStore.completeOnboarding()

Payload: {timeSlots: [...], thoughts: [{text, weight}]}
Existing programs unchanged.

Manual tests: 12/12 passing
Dev server: âœ“ no errors

Updates docs/WORKLOG.md (entry for TASK-2026-01-05-C)
```

---

## Mandatory Worklog Update

**File:** `docs/WORKLOG.md` (ALWAYS allowed per Worklog Exception Rule)

**Entry Format:**
```markdown
## 2026-01-05 [HH:MM] - Antigravity - COMPLETED

**Task**: TASK-2026-01-05-C - Add Thought Detachment Ritual program card

**Files Modified**:
- `src/components/ThoughtDetachmentOnboarding.jsx` (new: 4-step onboarding modal)
- `src/components/Cycle/ConsistencyFoundation.jsx` (added program card grid)
- [Optional] `src/components/ProgramCard.jsx` (new: reusable card component)

**Changes**:
- Added new program card in Navigation section Programs grid
- Implemented 4-step onboarding: Welcome, Thought Collection, Priority Marking, Time Selection
- Cancel flow returns to grid without state changes
- Complete flow calls curriculumStore.completeOnboarding(timeSlots, thoughts)
- Existing Foundation Cycle program unchanged

**Version**: v3.15.X (or next patch version)

**Status**: COMPLETED

**Commit**: [commit hash from git log]

**Notes**:
- Payload shape: {timeSlots: string[], thoughts: [{text, weight}]}
- Reused existing completeOnboarding() API
- Minimal UI for proof-of-concept
- All 12 manual tests passing

---
```

**CRITICAL:** This worklog entry MUST be included in the SAME commit as the code changes.

---

## Questions for User (Optional - Answer Before Implementation)

1. **Icon Choice:** Prefer ðŸŒŠ (wave), ðŸ’­ (thought bubble), ðŸ§˜ (meditation), or ðŸª· (lotus)?
2. **Onboarding Steps:** 4 steps as spec'd, or condense to 2-3 for MVP?
3. **Speech-to-Text:** Include or manual entry only for proof-of-concept?
4. **ProgramCard Component:** Extract as reusable or inline in ConsistencyFoundation?

---

## Implementation Notes

- This spec is approved for Antigravity implementation
- Do not begin work until user confirms approval
- Follow MULTI_AI_WORKFLOW.md protocols
- Update WORKLOG.md in same commit (mandatory)
- Test thoroughly before committing
- No version bump required unless user requests
