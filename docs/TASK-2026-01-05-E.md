# TASK-2026-01-05-E: Thought Detachment Ritual (Spec Sheet)

**Created:** 2026-01-05
**Recommended Executor:** Antigravity (UI flow) + Codex CLI (data contract)
**Scope:** Complete ritual session flow from launch to completion
**Goal:** Specify all behavioral contracts for the Thought Detachment Ritual practice session

---

## Summary

This spec defines the **runtime practice session** for the Thought Detachment Ritual program. It covers:
- Entry points (how users launch the ritual)
- Session flow (step sequence, timing, interrupts)
- UI state model (state machine transitions)
- Content structure (what gets displayed, not the actual spiritual content)
- Data tracking (what gets recorded and where)
- Responsiveness constraints (320px width, no hidden cards)

**Context:** The ritual program card and onboarding flow are defined in TASK-2026-01-05-C. This spec addresses what happens AFTER onboarding completes, when a user actually performs the ritual.

---

## A) User Flow Map

### Entry â†’ Steps â†’ Completion

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ENTRY POINTS                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Program Card (ConsistencyFoundation.jsx)                â”‚
â”‚    â†’ User clicks "Begin Practice" on Thought Detachment     â”‚
â”‚       Ritual card                                            â”‚
â”‚                                                              â”‚
â”‚ 2. Dashboard Quick Start (HomeHub.jsx)                      â”‚
â”‚    â†’ "Continue Today's Practice" button if ritual is        â”‚
â”‚       today's practice                                       â”‚
â”‚                                                              â”‚
â”‚ 3. Practice Schedule Notification                           â”‚
â”‚    â†’ Timed reminder (uses practiceTimeSlots from onboarding)â”‚
â”‚                                                              â”‚
â”‚ Preconditions:                                              â”‚
â”‚ - curriculumStore.onboardingComplete === true               â”‚
â”‚ - curriculumStore.thoughtCatalog has 5-8 thoughts          â”‚
â”‚ - curriculumStore.practiceTimeSlots has 2 times            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   RITUAL SESSION FLOW                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ State: INTRO                                                 â”‚
â”‚ â†’ Display ritual welcome screen                             â”‚
â”‚ â†’ Show session overview (duration, step count)              â”‚
â”‚ â†’ User clicks "Begin Ritual"                                â”‚
â”‚                                                              â”‚
â”‚        [Cancel â†’ Exit to Programs grid, no state change]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ State: ACTIVE (Step Loop)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 1: Ground (60s)                                         â”‚
â”‚ â†’ Instruction: Settle into stillness                        â”‚
â”‚ â†’ Timer: 60s countdown                                       â”‚
â”‚ â†’ Auto-advance when timer completes                         â”‚
â”‚                                                              â”‚
â”‚ Step 2: Observe (Variable, 120-300s)                        â”‚
â”‚ â†’ Fetch weighted random thought from thoughtCatalog         â”‚
â”‚ â†’ Display thought text                                       â”‚
â”‚ â†’ Instruction: Observe without engaging                     â”‚
â”‚ â†’ Timer: User-configurable duration (default 180s)          â”‚
â”‚ â†’ Auto-advance when timer completes                         â”‚
â”‚                                                              â”‚
â”‚ Step 3: Release (60s)                                        â”‚
â”‚ â†’ Instruction: Let the thought dissolve                     â”‚
â”‚ â†’ Timer: 60s countdown                                       â”‚
â”‚ â†’ Auto-advance â†’ Completion                                 â”‚
â”‚                                                              â”‚
â”‚ Controls:                                                    â”‚
â”‚ - Pause/Resume (tap anywhere)                               â”‚
â”‚ - Skip Step (skip button, only if enabled in settings)      â”‚
â”‚ - Exit (exit button â†’ confirmation modal)                   â”‚
â”‚                                                              â”‚
â”‚        [Exit â†’ Abort confirmation â†’ No tracking written]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ State: COMPLETION                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â†’ Display completion summary                                â”‚
â”‚ â†’ Show total session duration                               â”‚
â”‚ â†’ Optional: Focus rating (1-5 stars)                        â”‚
â”‚ â†’ Optional: Notes field                                      â”‚
â”‚ â†’ "Complete" button â†’ Write tracking data                   â”‚
â”‚                                                              â”‚
â”‚        [Complete â†’ Tracking write â†’ Return to Programs]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Interrupt Handling

| Event | State | Behavior |
|-------|-------|----------|
| App backgrounded | ACTIVE | â†’ Pause timer, preserve step state |
| App foregrounded | PAUSED | â†’ Resume button shown, user must explicitly resume |
| Navigate away | ACTIVE | â†’ Confirmation modal: "Exit ritual? Progress will not be saved" |
| Browser refresh | ACTIVE | â†’ Session lost (no localStorage persistence for active sessions) |
| Exit button | Any | â†’ Confirmation modal â†’ Abort (no tracking write) |
| Cancel button | INTRO | â†’ Immediate exit, no confirmation needed |

---

## B) State Machine Table

### States

| State | Description |
|-------|-------------|
| `idle` | No ritual session active |
| `intro` | Welcome screen shown, ritual not started |
| `active` | Ritual in progress, timer running |
| `paused` | Ritual paused by user or app interrupt |
| `completed` | All steps finished, awaiting user confirmation |
| `aborted` | User exited mid-session, no tracking recorded |

### Events

| Event | Trigger |
|-------|---------|
| `start_ritual` | User clicks "Begin Ritual" from program card |
| `begin_session` | User clicks "Begin Ritual" on intro screen |
| `pause` | User taps screen or app backgrounded |
| `resume` | User clicks resume button |
| `step_complete` | Timer reaches 0 for current step |
| `skip_step` | User clicks skip button (if enabled) |
| `exit_requested` | User clicks exit button |
| `confirm_abort` | User confirms exit in modal |
| `complete_session` | User clicks "Complete" on completion screen |
| `cancel_intro` | User clicks cancel on intro screen |

### Transitions

| From State | Event | Guards | To State | Side Effects |
|------------|-------|--------|----------|--------------|
| `idle` | `start_ritual` | onboardingComplete === true | `intro` | Load ritual data |
| `intro` | `begin_session` | - | `active` | Start step 1 timer, record startTime |
| `intro` | `cancel_intro` | - | `idle` | Clear session state |
| `active` | `pause` | - | `paused` | Stop timer, preserve elapsed time |
| `paused` | `resume` | - | `active` | Resume timer from preserved state |
| `active` | `step_complete` | currentStep < totalSteps | `active` | Advance to next step, reset timer |
| `active` | `step_complete` | currentStep === totalSteps | `completed` | Calculate total duration |
| `active` | `skip_step` | skipEnabled === true | `active` | Advance to next step (no penalty) |
| `active` | `exit_requested` | - | `paused` | Show confirmation modal |
| `paused` | `confirm_abort` | - | `aborted` | Clear session state |
| `completed` | `complete_session` | - | `idle` | Write tracking data, return to program |
| `aborted` | - | - | `idle` | No tracking write |

### Guards (Preconditions)

| Guard | Check |
|-------|-------|
| `onboardingComplete === true` | curriculumStore.onboardingComplete |
| `thoughtCatalog.length >= 5` | curriculumStore.thoughtCatalog.length >= 5 |
| `currentStep < totalSteps` | currentStepIndex < ritual.steps.length - 1 |
| `skipEnabled === true` | settingsStore.allowSkipSteps (default: false) |

---

## C) UI Contract Per Step

### Intro Screen

**Component:** `ThoughtDetachmentRitualIntro.jsx` (new)

**Regions:**
1. **Header** (centered)
   - Icon: ğŸŒŠ (wave emoji)
   - Title: "Thought Detachment Ritual"
   - Duration estimate: "~5-8 minutes"

2. **Description** (centered, max-width 600px)
   - Philosophy text (content slot: `ritual.description`)
   - Example: "Observe recurring thoughts without engagement. Not about changing thoughts, but changing your relationship to them."

3. **Actions** (centered, bottom)
   - Primary button: "Begin Ritual" â†’ `begin_session` event
   - Secondary button: "Cancel" â†’ `cancel_intro` event

**Responsive:**
- 320px width: Stack vertically, text line-clamp-3
- 375px+: Same layout
- Desktop: Max-width 600px container

---

### Active Session Screen

**Component:** `ThoughtDetachmentRitualSession.jsx` (new)

**Layout:** (similar to RitualSession.jsx structure)

**Regions:**
1. **Top Bar** (fixed, z-index high)
   - Exit button (top-right): "Exit" â†’ `exit_requested` event
   - Step indicator: "Step 2 of 3"

2. **Main Content** (flex-1, centered)
   - **Visual Layer** (background, subtle animation)
     - Step 1 (Ground): Breathing wave animation
     - Step 2 (Observe): Thought text displayed with fade-in
     - Step 3 (Release): Dissolve animation

   - **Instruction Panel** (foreground, glass capsule)
     - Step title (h2): "Ground", "Observe", "Release"
     - Instruction text (p): Content slot from ritual.steps[n].instruction
     - Timer display: "1:23" (MM:SS format)

3. **Bottom Controls** (fixed, gradient overlay)
   - Pause/Resume button (center, large): â¸ / â–¶
   - Progress bar: Visual indicator of current step + total progress

**Responsive:**
- 320px width: Instruction panel max-width 90vw, text line-clamp-3
- Tap anywhere â†’ toggle pause (matches existing ritual pattern)

**What Changes Per Step:**

| Step | Visual | Title | Instruction Slot | Timer Duration |
|------|--------|-------|------------------|----------------|
| 1 | Breathing wave | "Ground" | `ritual.steps[0].instruction` | 60s |
| 2 | Thought text display | "Observe" | `ritual.steps[1].instruction` + thought.text | 120-300s |
| 3 | Dissolve animation | "Release" | `ritual.steps[2].instruction` | 60s |

**Step 2 Specific:**
- Fetch thought: `curriculumStore.getWeightedRandomThought()`
- Display thought.text in large serif font (Playfair Display)
- Priority thoughts (weight: 1) have 3x selection probability

**Pause State:**
- Overlay indicator: "PAUSED" badge (top-right, black/60 bg)
- Timer stops counting
- Resume button pulses gently

---

### Completion Screen

**Component:** `ThoughtDetachmentRitualCompletion.jsx` (new)

**Regions:**
1. **Header** (centered)
   - Icon: âœ“ (checkmark)
   - Title: "Ritual Complete"
   - Duration summary: "Completed in 6m 32s"

2. **Reflection Form** (optional)
   - Focus rating (1-5 stars, tap to select)
   - Notes field (textarea, placeholder: "Optional notes...")
   - Both fields optional, can skip

3. **Actions** (centered, bottom)
   - Primary button: "Complete" â†’ `complete_session` event
   - No cancel option (ritual already finished)

**Responsive:**
- 320px width: Notes textarea min-height 80px, max-width 90vw
- Star rating: 5 stars in horizontal row, tap to select

---

## D) Data Contract

### What Gets Recorded

**Storage Location:** `curriculumStore.logLegCompletion(dayNumber, legNumber, data)`

**Fields:**

| Field | Type | Source | Example |
|-------|------|--------|---------|
| `dayNumber` | number | curriculumStore.getCurrentDayNumber() | 3 |
| `legNumber` | number | Ritual leg ID (e.g., 2 for evening ritual) | 2 |
| `completed` | boolean | Always true on completion | true |
| `date` | ISO string | new Date().toISOString() | "2026-01-05T19:23:45.123Z" |
| `duration` | number | totalTimeElapsed (seconds) | 392 |
| `focusRating` | number | null | User-selected 1-5 or null |
| `challenges` | array | [] | Empty for thought ritual |
| `notes` | string | User-entered text | "Noticed less reactivity" |
| `thoughtObserved` | string | thought.text from Step 2 | "I'm not good enough" |
| `thoughtId` | string | thought.id | "thought-1736094123-0" |

**Write Timing:**
- **When:** User clicks "Complete" on completion screen
- **Idempotency:** Check if legKey already exists before writing
  - If `curriculumStore.isLegComplete(dayNumber, legNumber) === true`, show warning: "Already completed today. Overwrite?"
  - User confirms â†’ overwrite existing entry
  - User cancels â†’ return to completion screen

**Error Handling:**

| Error | Cause | Recovery |
|-------|-------|----------|
| thoughtCatalog empty | User hasn't completed onboarding | Show error: "No thoughts configured. Complete onboarding first." â†’ Redirect to onboarding |
| getCurrentDayNumber fails | curriculumStartDate missing | Show error: "Curriculum not initialized" â†’ Redirect to program selection |
| localStorage quota exceeded | Browser storage full | Show error: "Cannot save. Clear app data or browser storage." |

**Handoff Signature:**

```javascript
// Existing API (NO EDITS to curriculumStore.js)
curriculumStore.logLegCompletion(
  dayNumber,    // number (1-14)
  legNumber,    // number (1-2)
  {
    duration: 392,                          // seconds
    focusRating: 4,                         // 1-5 or null
    challenges: [],                         // always empty for this ritual
    notes: "User notes here",               // string or empty
    thoughtObserved: "I'm not good enough", // NEW field (optional)
    thoughtId: "thought-1736094123-0"       // NEW field (optional)
  }
);
```

**Data Schema Extension:**

Since `curriculumStore.logLegCompletion` accepts a flexible `data` object, we can pass extra fields (`thoughtObserved`, `thoughtId`) without modifying the store. These fields will be persisted in `legCompletions[legKey]` automatically.

---

## E) Acceptance Criteria + Verification Checklist

### AC-1: Entry Points

**Must Pass:**
- [ ] Clicking "Begin Practice" on Thought Detachment Ritual card launches intro screen
- [ ] Intro screen loads within 500ms
- [ ] Cancel button returns to Programs grid with no state changes
- [ ] "Begin Ritual" button transitions to Step 1

### AC-2: Session Flow

**Must Pass:**
- [ ] Step 1 timer counts down from 60s to 0
- [ ] Auto-advance from Step 1 â†’ Step 2 at timer=0
- [ ] Step 2 displays a weighted random thought from thoughtCatalog
- [ ] Priority thoughts (weight: 1) appear ~3x more often than normal thoughts
- [ ] Step 2 timer counts down from configured duration (default 180s)
- [ ] Auto-advance from Step 2 â†’ Step 3 at timer=0
- [ ] Step 3 timer counts down from 60s to 0
- [ ] Auto-advance from Step 3 â†’ Completion screen at timer=0

### AC-3: Pause/Resume

**Must Pass:**
- [ ] Tap anywhere during active session â†’ pauses timer
- [ ] "PAUSED" indicator appears when paused
- [ ] Timer stops incrementing when paused
- [ ] Resume button appears when paused
- [ ] Clicking resume â†’ timer continues from preserved state
- [ ] App backgrounded â†’ session auto-pauses
- [ ] App foregrounded â†’ resume button shown (does not auto-resume)

### AC-4: Exit/Abort

**Must Pass:**
- [ ] Exit button shows confirmation modal: "Exit ritual? Progress will not be saved"
- [ ] Confirm exit â†’ returns to Programs grid, no tracking write
- [ ] Cancel modal â†’ returns to paused session
- [ ] Navigating away (browser back) â†’ same confirmation modal
- [ ] Session aborted â†’ `curriculumStore.legCompletions` unchanged

### AC-5: Completion & Tracking

**Must Pass:**
- [ ] Completion screen shows total duration in MM:SS format
- [ ] Focus rating (1-5 stars) is optional
- [ ] Notes field is optional
- [ ] "Complete" button writes to `curriculumStore.logLegCompletion()`
- [ ] Data includes: dayNumber, legNumber, duration, focusRating, notes, thoughtObserved, thoughtId
- [ ] Idempotency check: If leg already complete, show overwrite confirmation
- [ ] Successful write â†’ returns to Programs grid
- [ ] `curriculumStore.isLegComplete(dayNumber, legNumber)` returns true after completion

### AC-6: Responsiveness (320/375/390/Desktop)

**Must Pass:**
- [ ] At 320px width: No horizontal overflow
- [ ] At 320px width: Instruction text uses line-clamp-3 if needed
- [ ] At 320px width: Pause button remains tappable (min-width 48px)
- [ ] At 320px width: Notes textarea max-width 90vw
- [ ] At 375px width: All AC-6 checks pass
- [ ] At 390px width: All AC-6 checks pass
- [ ] At 1080px (Hearth desktop): Content max-width 600px, centered

### AC-7: Content Slots (Structure Only)

**Must Pass:**
- [ ] Intro screen displays `ritual.description` text
- [ ] Step 1 displays `ritual.steps[0].instruction` text
- [ ] Step 2 displays `ritual.steps[1].instruction` + `thought.text`
- [ ] Step 3 displays `ritual.steps[2].instruction` text
- [ ] Completion screen displays duration summary

**Note:** Actual spiritual content NOT required for AC-7. Placeholder text acceptable for spec validation.

### AC-8: Error Handling

**Must Pass:**
- [ ] If thoughtCatalog empty â†’ show error "No thoughts configured" â†’ redirect to onboarding
- [ ] If curriculumStartDate missing â†’ show error "Curriculum not initialized" â†’ redirect to program selection
- [ ] If localStorage quota exceeded â†’ show error "Cannot save. Clear app data."

### AC-9: UI Constraints (Non-Negotiables from TASK-2026-01-05-D)

**Must Pass:**
- [ ] No program cards are hidden at 320px width
- [ ] Active program card is highlighted only (not hidden)
- [ ] No complex inline JS inside JSX (no IIFEs, extract to functions)
- [ ] No horizontal scroll required on any screen at 320px

---

## F) Handoff Checklist for Implementers (Phased)

### Phase 1: Component Scaffolding (NO IMPLEMENTATION)

**Antigravity:**
- [ ] Create component files:
  - `src/components/ThoughtDetachmentRitualIntro.jsx`
  - `src/components/ThoughtDetachmentRitualSession.jsx`
  - `src/components/ThoughtDetachmentRitualCompletion.jsx`
- [ ] Define props interfaces for each component
- [ ] Map content slots to props (title, description, instruction, etc.)
- [ ] Identify reusable components (timer, progress bar, pause button)

**Codex CLI:**
- [ ] Define data schema for tracking write
- [ ] Document `logLegCompletion` payload structure
- [ ] Create utility function: `getWeightedRandomThought()` (if not exists)
- [ ] Verify `curriculumStore.isLegComplete()` exists and works

### Phase 2: State Machine Implementation

**Antigravity:**
- [ ] Implement state machine in `ThoughtDetachmentRitualSession.jsx`:
  - States: idle, intro, active, paused, completed, aborted
  - Events: start_ritual, begin_session, pause, resume, step_complete, exit_requested, etc.
  - Transitions per table in Section B
- [ ] Add guards: onboardingComplete, thoughtCatalog.length >= 5
- [ ] Wire pause/resume logic (tap anywhere â†’ toggle)
- [ ] Wire exit confirmation modal

### Phase 3: Timer & Step Logic

**Antigravity:**
- [ ] Implement step timer (60s, 120-300s, 60s)
- [ ] Auto-advance on step_complete event
- [ ] Preserve timer state on pause
- [ ] Calculate total duration on completion
- [ ] Fetch random thought in Step 2: `curriculumStore.getWeightedRandomThought()`

**Codex CLI:**
- [ ] Test `getWeightedRandomThought()` with priority weights
- [ ] Verify priority thoughts (weight: 1) appear 3x more often

### Phase 4: Tracking Write

**Codex CLI:**
- [ ] Implement idempotency check: `curriculumStore.isLegComplete(dayNumber, legNumber)`
- [ ] Show overwrite confirmation if leg already complete
- [ ] Wire "Complete" button â†’ `logLegCompletion()` call
- [ ] Pass payload: { duration, focusRating, notes, thoughtObserved, thoughtId }
- [ ] Verify write to localStorage: `immanenceOS.curriculum` key

**Antigravity:**
- [ ] Build completion form: focus rating (1-5 stars), notes textarea
- [ ] Make both fields optional
- [ ] Wire "Complete" button to tracking write

### Phase 5: Responsiveness & Visual Polish

**Antigravity:**
- [ ] Apply TASK-2026-01-05-D guardrails:
  - Instruction panel: max-width min(600px, 90vw)
  - Text: line-clamp-3 at 320px if needed
  - Pause button: min-width 48px (touch target)
- [ ] Test at 320px, 375px, 390px, 1080px
- [ ] Verify no horizontal overflow
- [ ] Add visual animations (breathing wave, dissolve)

### Phase 6: Integration & Entry Points

**Antigravity:**
- [ ] Wire entry from `ConsistencyFoundation.jsx`:
  - "Begin Practice" button â†’ launch intro
- [ ] Wire entry from `HomeHub.jsx` (if applicable):
  - "Continue Today's Practice" â†’ launch intro
- [ ] Test full flow: Program card â†’ Intro â†’ Session â†’ Completion â†’ Tracking write

### Phase 7: Error Handling & Edge Cases

**Codex CLI:**
- [ ] Test error: thoughtCatalog empty â†’ show error â†’ redirect to onboarding
- [ ] Test error: curriculumStartDate missing â†’ show error â†’ redirect to program selection
- [ ] Test error: localStorage quota exceeded â†’ show error

**Antigravity:**
- [ ] Test interrupt: App backgrounded â†’ auto-pause
- [ ] Test interrupt: Navigate away â†’ confirmation modal
- [ ] Test interrupt: Browser refresh â†’ session lost (acceptable)
- [ ] Test abort: Exit mid-session â†’ no tracking write

### Phase 8: Verification & Documentation

**Both:**
- [ ] Run AC-1 through AC-9 checks
- [ ] Screenshot each screen at 320px width
- [ ] Update WORKLOG.md with:
  - Task ID: TASK-2026-01-05-E
  - Files modified
  - Commit hash
  - Acceptance criteria results

---

## Out of Scope

**Excluded from this task:**
- Actual spiritual content text (use placeholders)
- Audio prompts or voiceover
- Advanced animations (simple fade-in/fade-out sufficient)
- Analytics tracking (session start/end events)
- Social sharing ("Share your progress")
- Multi-day streak tracking (handled by existing cycle system)
- Customizable step durations (use hardcoded defaults)
- Skip button functionality (default: disabled)

**Why excluded:** Focus on core ritual flow mechanics. Polish and content can be added later.

---

## Notes for Implementers

### Reuse Existing Patterns

**From RitualSession.jsx:**
- Intro/Active/Completion state flow
- Timer logic with requestAnimationFrame
- Pause/resume on tap
- Exit confirmation modal

**From curriculumStore.js:**
- `getWeightedRandomThought()` function (already exists, line 137-154)
- `logLegCompletion()` function (already exists, line 239-254)
- `isLegComplete()` function (already exists, line 259-263)

### Content Slot Placeholders

For proof-of-concept, use these placeholder strings:

```javascript
const RITUAL_CONTENT = {
  description: "A practice of observing recurring thoughts without engagement.",
  steps: [
    {
      id: 'ground',
      name: 'Ground',
      instruction: 'Settle into stillness. Let your breath anchor you.',
      duration: 60
    },
    {
      id: 'observe',
      name: 'Observe',
      instruction: 'Notice this thought. Observe without engaging.',
      duration: 180
    },
    {
      id: 'release',
      name: 'Release',
      instruction: 'Let the thought dissolve. Return to stillness.',
      duration: 60
    }
  ]
};
```

### Testing Tools

**320px Testing:**
- Chrome DevTools â†’ Device toolbar â†’ iPhone SE (320x568)
- Responsive mode â†’ Custom 320px width
- Console: Run overflow detection script from TASK-2026-01-05-D

**State Machine Testing:**
- Test all transitions in Section B table
- Verify guards prevent invalid transitions
- Test interrupt scenarios (background, navigate away)

### Common Pitfalls

1. **Forgetting idempotency:** Check `isLegComplete()` before writing
2. **Timer drift:** Use elapsed time calculation, not simple decrement
3. **Pause state preservation:** Store exact elapsed time when paused
4. **Thought weighting:** Verify priority thoughts appear 3x more often
5. **Responsive overflow:** Test instruction text at 320px with long thoughts

---

## Success Definition

**Task is DONE when:**
1. All AC-1 through AC-9 checks pass
2. Ritual completes successfully and writes to `curriculumStore.legCompletions`
3. No horizontal overflow at 320px, 375px, 390px
4. Exit/abort flow works without tracking writes
5. WORKLOG.md updated with TASK-2026-01-05-E entry

**Not required for DONE:**
- Actual spiritual content (placeholders acceptable)
- Advanced animations (simple fade sufficient)
- Audio prompts
- Analytics tracking

---

## Commit Message Template

```
feat(ritual): implement thought detachment ritual session flow - TASK-2026-01-05-E

Complete runtime practice session for thought detachment ritual.

Features:
- 3-step ritual flow: Ground (60s) â†’ Observe (180s) â†’ Release (60s)
- Weighted random thought selection from thoughtCatalog
- Pause/resume with timer preservation
- Exit confirmation with abort handling
- Completion tracking via curriculumStore.logLegCompletion()
- Responsive at 320px, 375px, 390px, desktop
- Idempotency check for duplicate completions

Components added:
- src/components/ThoughtDetachmentRitualIntro.jsx
- src/components/ThoughtDetachmentRitualSession.jsx
- src/components/ThoughtDetachmentRitualCompletion.jsx

State machine:
- States: idle, intro, active, paused, completed, aborted
- Events: start_ritual, begin_session, pause, resume, step_complete, exit_requested
- Transitions: 11 state transitions with guards

Testing:
- âœ“ All steps auto-advance on timer completion
- âœ“ Pause/resume preserves exact elapsed time
- âœ“ Exit confirmation prevents accidental abort
- âœ“ Tracking write includes thoughtObserved + thoughtId
- âœ“ No overflow at 320px width
- âœ“ Idempotency check prevents duplicate writes

Updates docs/WORKLOG.md (entry for TASK-2026-01-05-E)
```

---

## Mandatory Worklog Update

**File:** `docs/WORKLOG.md` (ALWAYS allowed per Worklog Exception Rule)

**Entry Format:**
```markdown
## 2026-01-05 [HH:MM] - [Agent Name] - COMPLETED

**Task**: TASK-2026-01-05-E - Thought Detachment Ritual session flow

**Files Modified**:
- `src/components/ThoughtDetachmentRitualIntro.jsx` (new, intro screen)
- `src/components/ThoughtDetachmentRitualSession.jsx` (new, state machine + timer)
- `src/components/ThoughtDetachmentRitualCompletion.jsx` (new, completion form)
- `src/components/Cycle/ConsistencyFoundation.jsx` (entry point wiring)
- [List any other modified files]

**Changes**:
- Implemented 3-step ritual flow with auto-advance
- Added weighted random thought selection (priority thoughts 3x probability)
- Built pause/resume with timer preservation
- Created exit confirmation modal (abort â†’ no tracking write)
- Wired completion tracking via logLegCompletion()
- Added idempotency check for duplicate completions
- Applied responsive guardrails (320px, 375px, 390px, desktop)

**Version**: v3.15.X (or next patch version)

**Status**: COMPLETED

**Commit**: [commit hash]

**Acceptance Criteria**:
- AC-1 through AC-9: PASS
- All state transitions verified
- Timer accuracy tested (no drift)
- Tracking write verified in localStorage
- No overflow at 320px width

**Notes**:
- Reused existing RitualSession.jsx pattern for state flow
- Extended curriculumStore schema with thoughtObserved + thoughtId fields
- Used placeholder spiritual content (to be replaced)
- Tested pause/resume with app backgrounding

---
```

**CRITICAL:** This worklog entry MUST be included in the SAME commit as the code changes.

---

## Questions for User (Answer Before Implementation)

1. **Step 2 duration:** Default 180s (3 minutes) configurable, or fixed?
2. **Skip button:** Should users be able to skip steps, or enforce full ritual?
3. **Focus rating:** Required or optional on completion?
4. **Thought rotation:** Same thought can appear multiple times in one session, or exclude recent thoughts?
5. **Entry points:** Only from program card, or also from HomeHub "Continue Practice" button?

---

## Appendix: State Machine Diagram

```
         â”Œâ”€â”€â”€â”€â”€â”€â”
         â”‚ idle â”‚
         â””â”€â”€â”¬â”€â”€â”€â”˜
            â”‚ start_ritual
            â”‚ (onboardingComplete)
         â”Œâ”€â”€â–¼â”€â”€â”€â”€â”
         â”‚ intro â”‚
         â””â”€â”€â”¬â”€â”¬â”€â”€â”˜
   cancel_introâ”‚ â”‚ begin_session
            â”‚ â”‚
            â”‚ â””â”€â”€â”€â”€â”€â”€â”
         â”Œâ”€â”€â–¼â”€â”€â”€â”€â”   â”‚
         â”‚ idle  â”‚   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”
                  â”‚active â”‚â—„â”€â”
                  â””â”€â”€â”¬â”€â”¬â”€â”€â”˜  â”‚
                     â”‚ â”‚step_complete
              pause  â”‚ â”‚(currentStep < total)
                     â”‚ â”‚
                  â”Œâ”€â”€â–¼â”€â–¼â”€â”€â”  â”‚
                  â”‚paused â”‚â”€â”€â”˜
                  â””â”€â”€â”¬â”€â”¬â”€â”€â”˜ resume
         confirm_abortâ”‚ â”‚
                     â”‚ â”‚
                  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”
                  â”‚abortedâ”‚
                  â””â”€â”€â”¬â”€â”€â”€â”€â”˜
                     â”‚
                  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”
                  â”‚ idle  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”˜

         (from active)
         step_complete
         (currentStep === total)
              â”‚
           â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ completed  â”‚
           â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ complete_session
           â”Œâ”€â”€â–¼â”€â”€â”€â”€â”
           â”‚ idle  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**End of Specification**
