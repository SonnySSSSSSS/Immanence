# TASK-2026-01-07-A: Photic Circles Overlay

**Status**: PENDING  
**Assigned**: Gemini/Antigravity (UI/UX) + Claude Code (State Logic)  
**Priority**: Testing Phase (no user warnings/gating yet)

---

## Goal

Implement a **"Photic Circles"** overlay that renders two pulsing circles at a selectable rate, with adjustable brightness, spacing, radius, and color. This is an experimental entrainment tool for light-based meditation, similar to Mindroid-style photic driving.

---

## Component Analysis (Reuse First)

### Existing Components Reviewed:

1. **`InstructionalOverlay.jsx`** - Modal overlay with backdrop blur

   - ✅ Can be used as **reference pattern** for overlay structure
   - ❌ Cannot reuse directly — different content model (image + caption vs. interactive circles)
   - **Decision**: Use similar z-index (`z-[1000]`) and animation patterns

2. **`BreathingRing.jsx`** - Breathing practice with pulsing ring

   - ✅ Uses `requestAnimationFrame` for timing — **Pattern reusable**
   - ❌ Canvas-based, uses breath phases, not frequency-based pulses
   - **Decision**: Borrow RAF timing pattern, not the ring itself

3. **`SoundConfig.jsx`** - Frequency slider with color mapping

   - ✅ Slider patterns reusable for Hz/brightness/spacing controls
   - ✅ Color palette approach reusable
   - **Decision**: REUSE slider styling patterns

4. **`settingsStore.js`** - Persistent settings with defaults and actions

   - ✅ Can be **extended** with photic settings section
   - **Decision**: EXTEND with photic settings (single object with nested properties)

5. **`displayModeStore.js`** - Light/dark mode detection
   - ✅ REUSE for control panel theming
   - **Decision**: REUSE AS-IS

### New Components Required:

| Component                      | Purpose                                      |
| ------------------------------ | -------------------------------------------- |
| `PhoticCirclesOverlay.jsx`     | Main overlay with circles + control panel    |
| `PhoticControlPanel.jsx`       | Settings UI (sliders, color picker, presets) |
| (Extension) `settingsStore.js` | Add `photic` settings object                 |

---

## File Scope

### ALLOWLIST (Files to Modify)

| File                                      | Changes                                          |
| ----------------------------------------- | ------------------------------------------------ |
| `src/components/PhoticCirclesOverlay.jsx` | **NEW** — Primary overlay component              |
| `src/components/PhoticControlPanel.jsx`   | **NEW** — Control panel with sliders and presets |
| `src/state/settingsStore.js`              | EXTEND — Add `photic` settings object            |
| `src/components/PracticeSection.jsx`      | Add "Photic" button to practice type switcher    |
| `src/App.jsx`                             | Version bump only                                |
| `docs/ARCHITECTURE.md`                    | Document new Photic system                       |
| `docs/WORKLOG.md`                         | Record changes                                   |

### DENYLIST (Do Not Modify)

- `src/components/Avatar.jsx` (protected)
- `src/components/MoonOrbit.jsx` (protected)
- `src/components/BreathingRing.jsx` (no changes needed)
- Any store other than `settingsStore.js`

---

## Settings Model

### State Separation (Critical)

**Two distinct states** to avoid confusion:

| State       | Location        | Purpose                 | Persisted?                |
| ----------- | --------------- | ----------------------- | ------------------------- |
| `isOpen`    | Component state | Overlay visibility (UI) | No (always false on load) |
| `isRunning` | Component state | Pulse engine active     | No (always false on load) |

**Why separate?**

- Overlay can be open but paused (configuring before starting)
- Prevents edge cases where "enabled" means both visible and pulsing
- Settings persist; UI state does not

### Persisted Settings (in `settingsStore.js`)

Add to `settingsStore.js` as a nested object:

```javascript
// Photic Circles settings (persisted)
photic: {
  // Timing
  rateHz: 2.0,              // Pulse frequency (default safe)
  dutyCycle: 0.5,           // On/off proportion (0.1-0.9)

  // Visual
  brightness: 0.6,          // Max opacity (0.0-1.0)
  spacingPx: 160,           // Center-to-center distance
  radiusPx: 120,            // Circle radius
  blurPx: 20,               // Glow blur radius (clamped to <= radiusPx)

  // Colors
  colorLeft: '#FFFFFF',     // Left circle color
  colorRight: '#FFFFFF',    // Right circle color
  linkColors: true,         // Sync left/right colors

  // Background
  bgOpacity: 0.95,          // Overlay background darkness
},
```

### Hard Limits (enforced in code)

| Setting      | Min | Max  | Default | Step                   |
| ------------ | --- | ---- | ------- | ---------------------- |
| `rateHz`     | 0.1 | 20.0 | 2.0     | 0.1 (≤5Hz), 0.5 (>5Hz) |
| `dutyCycle`  | 0.1 | 0.9  | 0.5     | 0.1                    |
| `brightness` | 0.0 | 1.0  | 0.6     | 0.05                   |
| `spacingPx`  | 40  | 320  | 160     | 10                     |
| `radiusPx`   | 40  | 240  | 120     | 10                     |
| `blurPx`     | 0   | 80   | 20      | 5                      |
| `bgOpacity`  | 0.7 | 1.0  | 0.95    | 0.05                   |

### UI Slider Soft Max

- **rateHz slider**: 0.1 – 12 Hz (slider range)
- **Advanced input**: Small numeric input beside slider labeled "(advanced)" for 12–20 Hz access
- Prevents accidental extreme rates while making experimentation discoverable

### Blur Clamping

- **blurPx** is clamped to `min(blurPx, radiusPx)` to prevent extreme glow artifacts
- Enforced in `setPhoticSetting` action

---

## UI Structure

### Overlay Layout

```
┌─────────────────────────────────────────────────────────────┐
│                     PHOTIC CIRCLES OVERLAY                   │
│                        (z-index: 1000)                       │
│                                                              │
│              ○                           ○                   │
│           (Left)                      (Right)                │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              CONTROL PANEL (bottom sheet)             │   │
│  │  [Rate: 2.0 Hz] [Brightness: 60%] [Spacing: 160px]   │   │
│  │  [Radius: 120px] [Color: ● ● ● ● ● ●] [Link: ✓]     │   │
│  │  [■ Start/Stop]                        [✕ Close]     │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### Responsive Behavior

| Mode                    | Control Panel Position        | Circle Centering         |
| ----------------------- | ----------------------------- | ------------------------ |
| **Hearth** (mobile)     | Bottom sheet, full width      | **Full viewport center** |
| **Sanctuary** (desktop) | Right side panel, fixed width | **Full viewport center** |

**Important**: Circles are centered in the **full browser viewport**, NOT the app frame (820px/430px container). This is intentional for proper eye alignment during photic entrainment. The overlay uses `position: fixed` with `inset: 0` to escape the app container.

### Color Palette Presets

Quick-select buttons for common colors:

1. **White** `#FFFFFF` (default)
2. **Soft Amber** `#FFD9A0`
3. **Warm Red** `#FF6B6B`
4. **Soft Green** `#7BC47F`
5. **Calm Blue** `#6FA8DC`
6. **Violet** `#B589D6`

---

## Rendering Strategy

### Circle DOM Structure (no canvas needed)

```jsx
<div
  className="photic-circle"
  style={{
    position: "absolute",
    top: "50%",
    left: `calc(50% - ${spacingPx / 2}px)`,
    transform: "translate(-50%, -50%)",
    width: `${radiusPx * 2}px`,
    height: `${radiusPx * 2}px`,
    borderRadius: "9999px",
    backgroundColor: colorLeft,
    opacity: intensity, // 0 or brightness
    boxShadow: `0 0 ${blurPx}px ${blurPx / 2}px ${colorLeft}`,
    transition: "none", // No CSS transitions (RAF handles timing)
  }}
/>
```

### Circle Positioning

- **cxLeft** = `calc(50% - spacingPx / 2)`
- **cxRight** = `calc(50% + spacingPx / 2)`
- **Y** = `50%` (vertically centered)

---

## Pulse Engine (Timing)

### Critical: Avoid React State for Intensity

**Problem**: Using `setIntensity(...)` every animation frame causes ~60 re-renders per second, which is:

- Wasteful (intensity only changes 2x per cycle for square wave)
- May cause stuttering on weaker devices

**Solution**: Use refs + direct DOM style updates:

```javascript
// Refs for direct DOM manipulation
const leftCircleRef = useRef(null);
const rightCircleRef = useRef(null);
const lastIntensityRef = useRef(0);

const pulseLoop = useCallback(() => {
  if (!isRunning) return;

  const now = performance.now();
  const periodMs = 1000 / rateHz;
  const elapsed = (now - startTimeRef.current) % periodMs;
  const isOn = elapsed < dutyCycle * periodMs;

  // Square wave: full brightness when on, 0 when off
  const intensity = isOn ? brightness : 0;

  // Only update DOM when intensity actually changes
  if (intensity !== lastIntensityRef.current) {
    lastIntensityRef.current = intensity;

    // Direct DOM updates (no React re-render)
    if (leftCircleRef.current) {
      leftCircleRef.current.style.opacity = intensity;
    }
    if (rightCircleRef.current) {
      rightCircleRef.current.style.opacity = intensity;
    }
  }

  rafRef.current = requestAnimationFrame(pulseLoop);
}, [isRunning, rateHz, dutyCycle, brightness]);
```

**Result**: Only 2 DOM updates per pulse cycle (on→off, off→on) instead of 60.

### Rate/DutyCycle Change Handling

When `rateHz` OR `dutyCycle` changes during running:

- **Reset phase** to prevent jarring jumps in the "on window"
- `startTimeRef.current = performance.now()` on either change

```javascript
useEffect(() => {
  if (isRunning) {
    startTimeRef.current = performance.now();
  }
}, [rateHz, dutyCycle]);
```

### Future Waveform Options

| Waveform             | Formula                                           | Use Case                          |
| -------------------- | ------------------------------------------------- | --------------------------------- |
| **Square** (default) | `on ? brightness : 0`                             | Mindroid-style, sharp transitions |
| **Sine**             | `brightness * (0.5 + 0.5 * sin(2π * rateHz * t))` | Smooth entrainment                |
| **Triangle**         | Linear ramp up/down                               | Gentler transitions               |

**Note**: For sine/triangle waveforms, intensity changes every frame. In that case, consider using CSS custom properties (`--photic-intensity`) updated via ref, with circles using `opacity: var(--photic-intensity)`. This still avoids React state re-renders.

---

## Implementation Steps

### Step A: Settings Store Extension

**Files**: `src/state/settingsStore.js`
**Changes**:

1. Add `photic` object with all settings and defaults
2. Add action `setPhoticSetting(key, value)` with clamping
3. Add action `resetPhoticSettings()`

### Step B: Create PhoticControlPanel Component

**Files**: `src/components/PhoticControlPanel.jsx` (NEW)
**Features**:

- Rate slider with Hz readout
- Brightness slider (0-100%)
- Spacing slider with px readout
- Radius slider with px readout
- Color palette buttons
- Link colors toggle
- Start/Stop button
- Close button

### Step C: Create PhoticCirclesOverlay Component

**Files**: `src/components/PhoticCirclesOverlay.jsx` (NEW)
**Features**:

- Full viewport overlay (`z-index: 1000`)
- Two circle divs with computed positions
- RAF-based pulse loop
- Control panel integration
- Responsive layout (Hearth vs Sanctuary)

### Step D: Wire into PracticeSection

**Files**: `src/components/PracticeSection.jsx`
**Changes**:

- Add "Photic" to practice type options (or separate button)
- Render `PhoticCirclesOverlay` when enabled
- OR: Add standalone "Photic" button in practice header

### Step E: Documentation

**Files**: `docs/ARCHITECTURE.md`, `docs/WORKLOG.md`
**Changes**:

- Add Photic Circles section to ARCHITECTURE.md
- Log implementation in WORKLOG.md

### Step F: Version Bump

**Files**: `src/App.jsx`
**Changes**:

- Increment patch version

---

## Test Checklist

- [ ] **Stability**: Start/Stop toggles without drift (rate stable for 60s)
- [ ] **Rate changes**: No violent jumps; phase resets smoothly
- [ ] **DutyCycle changes**: Phase resets to prevent "on window" jumps
- [ ] **Brightness**: 0 = completely off, 1.0 = full opacity
- [ ] **Spacing**: Circles move apart/together correctly while running
- [ ] **Colors**: Update live without restarting pulse
- [ ] **Limits**: Cannot set rate > 20 Hz or < 0.1 Hz
- [ ] **Blur clamping**: blurPx never exceeds radiusPx
- [ ] **Mobile (Hearth)**: Controls reachable; overlay not clipped
- [ ] **Desktop (Sanctuary)**: Control panel docks correctly
- [ ] **Viewport centering**: Circles centered in full viewport, not app frame
- [ ] **Close**: Overlay closes and pulse stops immediately
- [ ] **Persistence**: Settings (not isOpen/isRunning) survive page reload
- [ ] **Performance**: No React re-renders during pulse (verify with React DevTools)

---

## Constraints

1. **No canvas**: Use DOM + CSS only for circles (simpler, more predictable)
2. **No external dependencies**: Pure React + existing Framer Motion
3. **No React state for intensity**: Use refs + direct DOM updates
4. **Safe defaults**: Default rate 2 Hz, brightness 60% (gentle testing)
5. **Minimal diffs**: Self-contained overlay; minimal changes to existing files
6. **Testing phase**: No user warnings or photosensitivity gates yet (future phase)

---

## Version Target

**v3.15.63** (assuming current is v3.15.62)

---

## Commit Message Template

```
feat(photic): Add Photic Circles entrainment overlay

- Add PhoticCirclesOverlay with pulsing circles
- Add PhoticControlPanel with rate/brightness/spacing controls
- Extend settingsStore with photic settings object
- Wire into PracticeSection with "Photic" button
- Document in ARCHITECTURE.md

v3.15.63
```
